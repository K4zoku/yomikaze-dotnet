@page "/Comic/{id:int}"
@model Web.Pages.Comic.Details

@{
    Layout = "_Layout";
}

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('comic', () => ({
            id: @Model.Id,
            loading: true,
            comic: null,
            chapters: [],
            
            init() {
                this.auth = Alpine.store('auth');
                this.client = this.auth.http;
                this.client.get(`/API/OData/Comics/${this.id}?$expand=ComicGenres($expand=Genre)`)
                    .then(response => { setTimeout(() => { this.comic = response.data; this.loading = false }, 1000) })
                    .catch(error => console.error(error))
                this.fetchChapters();
            },
            
            async fetchChapters() {
                let url = new URL(`/API/OData/Chapters/`, window.location.origin);
                url.searchParams.set('$filter', `ComicId eq ${this.id}`);
                url.searchParams.set('$orderby', 'Index asc');
                this.chapters = await this.client.get(url)
                    .then(response => response.data.value)
                    .catch(error => { console.error(error); return []; });
            }
            
        }));
    });
</script>

<div class="max-w-screen w-full min-h-[calc(100vh-8rem)] bg-base-100" x-data="comic">
<div class="w-10/12 mx-auto py-10">
<div class="bg-base-100 rounded-box shadow-2xl p-10">
<div class="flex flex-col gap-8 flex-wrap justify-items-center">
<div class="flex flex-row flex-wrap md:flex-nowrap gap-8">
    <!-- Thumbnail -->
    <div class="shrink-0 flex-grow-0 mx-auto">
        <img alt="thumbnail" class="w-[190px] h-[280px] object-cover object-center rounded-box shadow-2xl"
             :src="comic?.Cover">
    </div>
    <!-- Detail -->
    <div class="flex-grow flex flex-col gap-4">
        <!-- Comic name -->
        <div class="flex gap-2">
            <div class="flex-grow">
                <div class="flex flex-col">
                    <div class="indicator">
                        <span class="indicator-item badge badge-secondary badge-sm">New</span>
                        <h2 class="text-3xl title-font font-medium" x-text="comic?.Name">Name</h2>
                    </div>
                    <span class="text-sm text-neutral italic" x-text="comic?.Aliases">Aliases</span>
                </div>
            </div>
            <div class="flex-shrink">
                <div class="a2a_kit a2a_kit_size_24 a2a_default_style" data-a2a-icon-color="transparent,#55B4D4">
                    <a class="a2a_button_copy_link" href="#copy_link"></a>
                    <a class="a2a_button_x" href="#x"></a>
                    <a class="a2a_button_facebook" href="#facebook"></a>
                    <a class="a2a_button_reddit" href="#reddit"></a>
                    <a class="a2a_dd" href="#dd"></a>
                </div>
                <script async="" src="https://static.addtoany.com/menu/page.js"></script>
            </div>

        </div>
        <!-- Comic attributes -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <dl class="grid grid-cols-5 gap-x-4 gap-y-2 flex-grow-0">
                <dt class="col-span-2 gap-2 font-bold">
                    <i data-feather="user"></i>
                    Authors
                </dt>
                <dd class="col-span-3" x-text="comic?.Authors">
                    Authors
                </dd>
                <dt class="col-span-2 gap-2 font-bold">
                    <i data-feather="activity"></i>
                    Status
                </dt>
                <dd class="col-span-3">
                    <span class="badge badge-outline badge-warning">Updating...</span>
                </dd>
                <dt class="col-span-2 gap-2 font-bold">
                    <i data-feather="clock"></i>
                    Last updated
                </dt>
                <dd class="col-span-3">
                    <span>an hour ago</span>
                </dd>
            </dl>
            <dl class="grid grid-cols-5 gap-x-4 gap-y-2 flex-grow-0">
                <dt class="col-span-2 gap-2 font-bold">
                    <i data-feather="calendar"></i>
                    Published
                </dt>
                <dd class="col-span-3" x-text="comic?.Published ? moment(comic?.Published).fromNow() : 'N/A'">

                    <span>18 hours ago</span>
                </dd>
                <dt class="col-span-2 gap-2 font-bold">
                    <i data-feather="calendar"></i>
                    Finished
                </dt>
                <dd class="col-span-3" x-text="comic?.Finished ? moment(comic?.Finished).fromNow() : 'N/A'">

                    <span>18 hours ago</span>
                </dd>
            </dl>
        </div>
        <!-- Comic genres -->
        <div class="grid grid-cols-5 gap-2">
            <div class="col-span-1">
                <span class="font-bold gap-2">
                    <i data-feather="tag"></i>
                    Genres
                </span>
            </div>
            <div class="col-span-4 grow flex flex-wrap flex-row gap-2">
                <template x-for="genre in comic?.ComicGenres">
                    <span class="badge badge-outline badge-primary" x-text="genre?.Genre?.Name">
                        Action
                    </span>
                    
                </template>
            </div>
        </div>
        <!-- Action button -->
        <div class="flex flex-row flex-wrap gap-2" x-data="{ authenticated: $store.auth.authenticated }">
            <!-- Read button -->

            <div class="tooltip" :data-tip="chapters.length === 0 ? 'Comic currently has no chapters' : 'Read'">
                <button 
                    class="btn btn-primary gap-2" :disabled="chapters.length === 0"
                    x-on:click="window.location.href = `/Comics/${comic?.Id}/Chapters/${chapters[0]?.Index}`">
                    <i data-feather="book-open"></i>
                    Read
                </button>
            </div>

            <!-- Continue reading button -->
            
            <div class="tooltip" data-tip="You must be logged in to continue reading" :class="{ tooltip: !authenticated }">
                <button class="btn btn-accent gap-2" :disabled="!authenticated">
                    <i data-feather="navigation"></i>
                    Continue reading
                </button>
            </div>

            <!-- Add to library button -->
            <div class="tooltip" data-tip="You must be logged in to add this comic to your library" :class="{ tooltip: !authenticated }">
                <button class="btn btn-error gap-2" :disabled="!authenticated">
                    <i data-feather="bookmark"></i>
                    Add to library
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Description -->
<label class="collapse collapse-plus bg-base-200 shadow-xl rounded-box" x-data="{open: true}">
    <input class="peer" type="checkbox" x-model="open">
    <span class="collapse-title gap-2">
        <i data-feather="info"></i>
        <span class="font-bold">
            Description
        </span>
        <span class="text-sm text-neutral italic" x-text="open ? '(click to collapse)' : '(click to expand)'">(click to collapse)</span>
    </span>
    <span class="collapse-content">
        <span class="leading-relaxed text-justify" x-text="comic?.Description">
            Description
        </span>
    </span>
</label>
<!-- Chapters -->
<label class="collapse collapse-plus bg-base-200 shadow-xl rounded-box" x-data="{open: true}">
    <input :checked="open" class="peer" type="checkbox" x-model="open" checked="checked">
    <span class="collapse-title gap-2">
        <i data-feather="list"></i>
        <span class="font-bold">
            Chapter
        </span>
        <span class="text-sm text-neutral italic" x-text="open ? '(click to collapse)' : '(click to expand)'">(click to collapse)</span>
    </span>
    <span class="collapse-content">

        <span class="italic" x-show="chapters.length === 0">
            No chapters available
        </span>
        <span class="max-h-[500px] divide-y divide-dashed overflow-y-auto pr-4">
            <template x-for="chapter in chapters">
                <span class="flex flex-nowrap items-center gap-4 p-2 hover:bg-accent hover:bg-opacity-30">
                    <a class="flex-grow flex flex-nowrap items-center gap-4" :href="`/Comics/${comic?.Id}/Chapters/${chapter?.Index}`">
                        <span class="flex-grow" x-text="chapter?.Title">
                            Chapter 1
                        </span>
                        <span x-text=" moment('2024-03-18T04:38:22.376Z').fromNow() ">a few seconds ago</span>
                    </a>
                </span>
            </template>
        </span>

    </span>
</label>
</div>
</div>
<!-- Comments -->


<form class="hidden" id="delete-comic-form" method="post" action="/comic/292236210020175872/delete">
    <input type="hidden" name="_csrf" value="b3f7ff6a-36f7-4bbd-88bb-3654fd06407c"><input type="hidden" name="_method" value="delete">
</form>
<input class="modal-toggle" id="delete-comic-modal" type="checkbox">
<label class="modal cursor-pointer" for="delete-comic-modal">
    <label class="modal-box relative">
        <h3 class="text-xl font-bold">Delete comic</h3>
        <p class="p-4">Are you sure you want to delete this comic?</p>
        <div class="modal-action">
            <label class="btn btn-ghost" for="delete-comic-modal">Cancel</label>
            <button class="btn btn-error" form="delete-comic-form" type="submit">Delete</button>
        </div>
    </label>
</label>

<form class="hidden" id="report-comic-form" method="post" action="/comic/292236210020175872/report">
    <input type="hidden" name="_csrf" value="b3f7ff6a-36f7-4bbd-88bb-3654fd06407c">
</form>

<input class="modal-toggle" id="report-comic-modal" type="checkbox">
<label class="modal cursor-pointer" for="report-comic-modal">
    <label class="modal-box relative">
        <h3 class="text-xl font-bold">Report comic</h3>
        <label class="label" for="reason">
            <span class="label-text">Reason</span>
        </label>
        <textarea class="w-full textarea textarea-bordered" id="reason" name="message" placeholder="Reason"></textarea>
        <div class="modal-action">
            <label class="btn btn-ghost" for="report-comic-modal">Cancel</label>
            <button class="btn btn-error" form="report-comic-form" type="submit">Report</button>
        </div>
    </label>
</label>
</div>
</div>