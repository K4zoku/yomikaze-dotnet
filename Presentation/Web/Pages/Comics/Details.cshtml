@page "/Comics/{id:int}"
@model Details

@{
    Layout = "_Layout";
}

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('comic', () => ({
            id: @Model.Id,
            loading: true,
            comic: null,
            chapters: [],
            
            init() {
                this.auth = Alpine.store('auth');
                this.client = this.auth.http;
                this.fetchDetails();
            },
            
            async fetchDetails() {
                this.comic = await this.client.get(`/API/OData/Comics(${this.id})?$expand=ComicGenres($expand=Genre)`)
                    .then(response => response.data)
                    .catch(error => {
                        if (error.response.status === 404) {
                            window.location.href = '/404';
                        }
                        console.error('Error while fetching comic details', error);
                        return null;
                    });
                
                await this.fetchChapters();
                await this.checkLibrary();
                this.loading = false;
            },
            
            async fetchChapters() {
                let url = new URL(`/API/OData/Chapters/`, window.location.origin);
                url.searchParams.set('$filter', `ComicId eq ${this.id}`);
                url.searchParams.set('$orderby', 'Index asc');
                this.chapters = await this.client.get(url)
                    .then(response => response.data.value)
                    .catch(error => { console.error(error); return []; });
            },
            
            _isInLibrary: false,
            
            async checkLibrary() {
                if (!this.auth.authenticated) return;
                this._isInLibrary = await this.client.get(`/API/Library/${this.id}`)
                    .then(() => true)
                    .catch(error => {
                        console.error('Error while checking library', error);
                        return false;
                    });
            },
            
            get isInLibrary() {
                return this._isInLibrary;
            },
            
            set isInLibrary(value) {
                this._isInLibrary = value;
                if (value) {
                    this.client.post(`/API/Library/${this.id}`)
                        .then(() => console.log('Added to library'))
                        .catch(error => console.error('Error while adding to library', error));
                } else {
                    this.client.delete(`/API/Library/${this.id}`)
                        .then(() => console.log('Removed from library'))
                        .catch(error => console.error('Error while removing from library', error));
                }
            },
            
            async deleteThis() {
                
                let error = await this.client.delete(`/API/Comics/${this.id}`)
                    .then(() => false)
                    .catch(error => {
                        console.error('Error while deleting comic', error);
                        return error;
                    });
                if (error) {
                    let message = error.response?.data?.message
                    if (message) {
                        alert(message);
                    }
                } else {
                    window.location.href = '/';
                }
            }
            
        }));
    });
</script>

<div class="max-w-screen w-full min-h-[calc(100vh-8rem)] bg-base-100" x-data="comic">
<div class="w-10/12 mx-auto py-10">
<div class="bg-base-100 rounded-box shadow-2xl p-10">
<div class="flex flex-col gap-8 flex-wrap justify-items-center">
<div class="flex flex-row flex-wrap md:flex-nowrap gap-8">
    <!-- Thumbnail -->
    <div class="shrink-0 flex-grow-0 mx-auto">
        <img alt="thumbnail" class="w-[190px] h-[280px] object-cover object-center rounded-box shadow-2xl"
             :src="comic?.Cover">
    </div>
    <!-- Detail -->
    <div class="flex-grow flex flex-col gap-4">
        <!-- Comic name -->
        <div class="flex gap-2">
            <div class="flex-grow">
                <div class="flex flex-col">
                    <div class="indicator">
                        <span class="indicator-item badge badge-secondary badge-sm">New</span>
                        <h2 class="text-3xl title-font font-medium" x-text="comic?.Name">Name</h2>
                    </div>
                    <span class="text-sm text-neutral italic" x-text="comic?.Aliases">Aliases</span>
                </div>
            </div>
            <div class="flex-shrink">
                <div class="a2a_kit a2a_kit_size_24 a2a_default_style" data-a2a-icon-color="transparent,#55B4D4">
                    <a class="a2a_button_copy_link"></a>
                    <a class="a2a_button_x"></a>
                    <a class="a2a_button_facebook"></a>
                    <a class="a2a_button_reddit"></a>
                    <a class="a2a_dd"></a>
                </div>
                <script async="" src="https://static.addtoany.com/menu/page.js"></script>
            </div>

        </div>
        <!-- Comic attributes -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
            <dl class="grid grid-cols-5 gap-x-4 gap-y-2 flex-grow-0">
                <dt class="col-span-2 gap-2 font-bold">
                    <i data-feather="user"></i>
                    Authors
                </dt>
                <dd class="col-span-3" x-text="comic?.Authors">
                    Authors
                </dd>
                <dt class="col-span-2 gap-2 font-bold">
                    <i data-feather="activity"></i>
                    Status
                </dt>
                <dd class="col-span-3">
                    <span class="badge badge-outline badge-warning">Updating...</span>
                </dd>
                <dt class="col-span-2 gap-2 font-bold">
                    <i data-feather="clock"></i>
                    Last updated
                </dt>
                <dd class="col-span-3">
                    <span>an hour ago</span>
                </dd>
            </dl>
            <dl class="grid grid-cols-5 gap-x-4 gap-y-2 flex-grow-0">
                <dt class="col-span-2 gap-2 font-bold">
                    <i data-feather="calendar"></i>
                    Published
                </dt>
                <dd class="col-span-3" x-text="comic?.Published ? moment(comic?.Published).fromNow() : 'N/A'">

                    <span>18 hours ago</span>
                </dd>
                <dt class="col-span-2 gap-2 font-bold">
                    <i data-feather="calendar"></i>
                    Finished
                </dt>
                <dd class="col-span-3" x-text="comic?.Finished ? moment(comic?.Finished).fromNow() : 'N/A'">

                    <span>18 hours ago</span>
                </dd>
            </dl>
        </div>
        <!-- Comic genres -->
        <div class="grid grid-cols-5 gap-2">
            <div class="col-span-1">
                <span class="font-bold gap-2">
                    <i data-feather="tag"></i>
                    Genres
                </span>
            </div>
            <div class="col-span-4 grow flex flex-wrap flex-row gap-2">
                <template x-for="genre in comic?.ComicGenres">
                    <span class="badge badge-outline badge-primary" x-text="genre?.Genre?.Name">
                        Genre
                    </span>

                </template>
            </div>
        </div>
        <!-- Action button -->
        <div class="flex flex-row flex-wrap gap-2" x-data="{ authenticated: $store.auth.authenticated }">
            <!-- Read button -->

            <div class="tooltip" :data-tip="chapters.length === 0 ? 'Comic currently has no chapters' : 'Read'">
                <button
                    class="btn btn-primary gap-2" :disabled="chapters.length === 0"
                    x-on:click="window.location.href = `/Comics/${comic?.Id}/Chapters/${chapters[0]?.Index}`">
                    <i data-feather="book-open"></i>
                    Read
                </button>
            </div>

            <!-- Continue reading button -->

            <div class="tooltip" data-tip="You must be logged in to continue reading" :class="{ tooltip: !authenticated }">
                <button class="btn btn-accent gap-2" :disabled="!authenticated">
                    <i data-feather="navigation"></i>
                    Continue reading
                </button>
            </div>

            <!-- Add to library button -->
            <div class="tooltip" data-tip="You must be logged in to add this comic to your library" :class="{ tooltip: !authenticated }">
                <label class="btn btn-error gap-2" :class="{ 'btn-disabled': !authenticated }">
                    <input type="checkbox" x-model="isInLibrary" class="hidden">
                    <i data-feather="bookmark"></i>
                    <span x-text="isInLibrary ? 'Remove from library' : 'Add to library'">Add to library</span>
                </label>
            </div>

            <template x-if="$store.auth.profile?.isAdmin">
                <div class="contents">
                    <dialog class="modal cursor-pointer" x-ref="deleteComicModal">
                        <label class="modal-box relative">
                            <h3 class="text-xl font-bold">Delete comic</h3>
                            <p class="p-4">Are you sure you want to delete this comic?</p>
                            <div class="modal-action">
                                <button class="btn btn-error" x-on:click="await deleteThis(); $refs.deleteComicModal.close();">Delete</button>
                                <form method="dialog">
                                    <button class="btn">Cancel</button>
                                </form>
                            </div>
                        </label>
                    </dialog>
                    <details class="dropdown">
                        <summary class="btn btn-ghost">
                            <i data-feather="settings" class="text-base-content" aria-hidden="true"></i>
                            Manage
                            <i data-feather="chevron-down" class="text-base-content" aria-hidden="true"></i>
                        </summary>
                        <ul class="dropdown-content menu menu-compact p-2 shadow-lg bg-base-200 rounded-box w-52 z-50">
                            <li>
                                <a asp-page="/Manage/Comic/Edit" asp-route-id="-1" :href="$el.href.replace('-1', id)">
                                    <i data-feather="edit" aria-hidden="true"></i>
                                    Edit comic
                                </a>
                            </li>
                            <li>
                                <a x-on:click="$refs.deleteComicModal.showModal()" class="text-error hover:bg-error hover:text-error-content">
                                    <i data-feather="trash-2" aria-hidden="true"></i>
                                    Delete comic
                                </a>
                            </li>
                        </ul>
                    </details>
                </div>
            </template>
        </div>
    </div>
</div>
<!-- Description -->
<label class="collapse collapse-plus bg-base-200 shadow-xl rounded-box" x-data="{open: true}">
    <input class="peer" type="checkbox" x-model="open">
    <span class="collapse-title gap-2">
        <i data-feather="info"></i>
        <span class="font-bold">
            Description
        </span>
        <span class="text-sm text-neutral italic" x-text="open ? '(click to collapse)' : '(click to expand)'">(click to collapse)</span>
    </span>
    <span class="collapse-content">
        <span class="leading-relaxed text-justify" x-text="comic?.Description">
            Description
        </span>
    </span>
</label>
<!-- Chapters -->
<label class="collapse collapse-plus bg-base-200 shadow-xl rounded-box" x-data="{open: true}">
    <input :checked="open" class="peer" type="checkbox" x-model="open" checked="checked">
    <span class="collapse-title gap-2">
        <i data-feather="list"></i>
        <span class="font-bold">
            Chapter
        </span>
        <span class="text-sm text-neutral italic" x-text="open ? '(click to collapse)' : '(click to expand)'">(click to collapse)</span>
    </span>
    <span class="collapse-content">

        <span class="italic" x-show="chapters.length === 0">
            No chapters available
        </span>
        <span class="max-h-[500px] divide-y divide-dashed overflow-y-auto pr-4">
            <template x-for="chapter in chapters">
                <span class="flex flex-nowrap items-center gap-4 p-2 hover:bg-accent hover:bg-opacity-30">
                    <a class="flex-grow flex flex-nowrap items-center gap-4" :href="`/Comics/${comic?.Id}/Chapters/${chapter?.Index}`">
                        <span class="flex-grow" x-text="chapter?.Title">
                            Chapter 1
                        </span>
                        <span x-text=" moment('2024-03-18T04:38:22.376Z').fromNow() ">a few seconds ago</span>
                    </a>
                </span>
            </template>
        </span>

    </span>
</label>
</div>
</div>
</div>
</div>